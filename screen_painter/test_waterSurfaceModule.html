<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #marker_receiver_canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        water-surface-canvas {
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>

    <script src="../libs/hammer.min.js"></script>
    <script src="../libs/Colors.js/Colors.js"></script>
    <script src="../libs/TimeChecker.js"></script>
</head>

<body>
    <div id="video_controller"></div>
    <water-surface-canvas></water-surface-canvas>
    <canvas id="marker_receiver_canvas"></canvas>

    <script type="module">
        import "./waterSurfaceModule.js";
        const water_surface_elem = document.querySelector("water-surface-canvas");

        const img = new Image();
        img.src = "./images/iu_front.png";
        img.onload = () => {
            water_surface_elem.init({ width: img.width, height: img.height });
            water_surface_elem.getContext().drawImage(img, 0, 0, img.width, img.height);
            // water_surface_elem.getContext().clearRect(0, 0, img.width, img.height);
        }

        const marker_canvas_elem = document.querySelector("#marker_receiver_canvas");
        ({ width: marker_canvas_elem.width, height: marker_canvas_elem.height } = marker_canvas_elem.getBoundingClientRect());
        ["pointerenter", "pointermove", "pointerleave"].forEach(name => {
            marker_canvas_elem.addEventListener(name, (ev) => {
                // console.log(name, ev)
                water_surface_elem._onMouseMove(ev)
            });
        });
        ["touchstart", "touchmove", "touchend"].forEach(name => {
            marker_canvas_elem.addEventListener(name, ev => {
                // console.log(name, ev)
                // water_surface_elem._onMouseMove(ev);
            });
        });
        import { marker_receiver } from "./marker_receiver.mjs";
        marker_receiver.init({ canvas_elem: marker_canvas_elem });

        import { camera } from "../libs/webcamera/camera.js";
        await camera.init({
            video_controller_elem: document.getElementById("video_controller"),
            video_resolution: [1024, 768],
            recognition_canvas_resolution: [320, 180],
        });

        import { CanvasData } from "../CanvasData.mjs";
        await CanvasData.import_modules();
        await CanvasData.init(camera.recognition_canvas());
        import GUI from "https://cdn.jsdelivr.net/npm/lil-gui@0.17/+esm";
        const gui = new GUI();
        gui.close();
        import { lil_gui_lib } from "../libs/lil_gui_lib.mjs";
        (await lil_gui_lib.init({ libs_backup_folder: "../libs_backup" })).set(gui);
        CanvasData.init_gui({ gui: gui });


        let prev_tm = Date.now();
        const render = async () => {
            const tm = Date.now();
            const dt = tm - prev_tm;

            camera.render();
            const recognize_canvas = camera.canvas2_bak();
            CanvasData.set_output_canvas(recognize_canvas[0])
            // CanvasData.set_output_canvas(camera.video_canvas())
            CanvasData.set_image(...recognize_canvas);
            const effective_pixels = await CanvasData.filter();
            await CanvasData.recognize(dt);
            const output_data = await CanvasData.output();
            // console.log(output_data)

            water_surface_elem.getContext().drawImage(camera.video_canvas(), 0, 0, ...camera.video_canvas_wh())

            marker_receiver.render();
            requestAnimationFrame(render);

            prev_tm = tm;
        }
        requestAnimationFrame(render);
    </script>
</body>

</html>